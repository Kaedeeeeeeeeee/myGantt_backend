// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProjectRole {
  VIEWER
  EDITOR
  ADMIN
  OWNER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
}

enum SubscriptionPlan {
  FREE
  BASIC
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  googleId  String?  @unique @map("google_id")
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  subscriptionPlan      SubscriptionPlan   @default(FREE) @map("subscription_plan")
  subscriptionStatus    SubscriptionStatus @default(ACTIVE) @map("subscription_status")
  subscriptionStartDate DateTime?          @map("subscription_start_date")
  subscriptionEndDate   DateTime?          @map("subscription_end_date")
  stripeCustomerId      String?            @unique @map("stripe_customer_id")
  stripeSubscriptionId  String?            @unique @map("stripe_subscription_id")
  isFirstTimeSubscriber Boolean            @default(true) @map("is_first_time_subscriber")

  projects        Project[]
  projectMembers  ProjectMember[]
  sentInvitations ProjectInvitation[] @relation("SentInvitations")

  @@map("users")
}

model Project {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks       Task[]
  members     ProjectMember[]
  invitations ProjectInvitation[]

  @@index([userId])
  @@map("projects")
}

model Task {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  name        String
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  progress    Int      @default(0) // 0-100
  color       String?
  assignee    String?
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project      Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  dependencies TaskDependency[] @relation("TaskDependencies")
  dependents   TaskDependency[] @relation("TaskDependents")

  @@index([projectId])
  @@index([startDate, endDate])
  @@map("tasks")
}

model TaskDependency {
  id              String   @id @default(uuid())
  taskId          String   @map("task_id")
  dependsOnTaskId String   @map("depends_on_task_id")
  createdAt       DateTime @default(now()) @map("created_at")

  task          Task @relation("TaskDependencies", fields: [taskId], references: [id], onDelete: Cascade)
  dependsOnTask Task @relation("TaskDependents", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)

  @@unique([taskId, dependsOnTaskId])
  @@index([taskId])
  @@index([dependsOnTaskId])
  @@map("task_dependencies")
}

model ProjectMember {
  id        String      @id @default(uuid())
  projectId String      @map("project_id")
  userId    String      @map("user_id")
  role      ProjectRole @default(VIEWER)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

model ProjectInvitation {
  id           String           @id @default(uuid())
  projectId    String           @map("project_id")
  inviterId    String           @map("inviter_id")
  inviteeEmail String           @map("invitee_email")
  role         ProjectRole      @default(VIEWER)
  token        String           @unique
  status       InvitationStatus @default(PENDING)
  expiresAt    DateTime         @map("expires_at")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  inviter User    @relation("SentInvitations", fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([inviteeEmail])
  @@index([projectId])
  @@index([status])
  @@map("project_invitations")
}
